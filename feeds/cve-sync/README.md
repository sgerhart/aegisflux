# CVE Sync Service

Fetches CVE data from NVD (National Vulnerability Database), normalizes to internal CVE document format, and publishes to NATS `feeds.cve.updates`.

## Features

- **Paginated API Fetching**: Efficiently retrieves all CVE data using NVD API pagination
- **API Key Support**: Optional NVD API key for higher rate limits (50 requests/minute vs 5/minute)
- **Comprehensive Normalization**: 
  - CVSS scores (v2, v3.0, v3.1) with base, temporal, and environmental metrics
  - CWE (Common Weakness Enumeration) data
  - Affected products with CPE parsing
  - References and external links
- **Robust Error Handling**: Retry logic with exponential backoff
- **Rate Limiting**: Respectful API usage with built-in delays
- **Structured Logging**: Comprehensive logging for monitoring and debugging

## Configuration

### Vault Integration (Recommended)

The service integrates with HashiCorp Vault for secure secret management:

#### Vault Secrets

**NVD API Configuration:**
```bash
# Store NVD API key in Vault
vault kv put secret/cve-sync/nvd \
  api_key="your-nvd-api-key" \
  rate_limit=50 \
  timeout=30

# Store general configuration
vault kv put secret/cve-sync/config \
  max_pages=10 \
  retry_attempts=3 \
  cache_ttl=300
```

**Vault Policy:**
```hcl
path "secret/data/cve-sync/*" { capabilities = ["read"] }
```

#### Environment Variables for Vault

- `VAULT_ADDR`: Vault server address (default: `http://localhost:8200`)
- `VAULT_TOKEN`: Vault authentication token
- `VAULT_DEV_MODE`: Development mode flag (default: `true`)

### Environment Variables (Fallback)

- `NATS_URL`: NATS server URL (default: `nats://localhost:4222`)
- `NVD_API_KEY`: Optional NVD API key for higher rate limits (overrides Vault)
- `NVD_MAX_PAGES`: Maximum pages to fetch (overrides Vault)

### NVD API Key

To get an NVD API key:
1. Visit [NVD API Key Request](https://nvd.nist.gov/developers/request-an-api-key)
2. Fill out the form and wait for approval
3. Store in Vault: `vault kv put secret/cve-sync/nvd api_key="your-key"`

## Usage

### Basic Usage
```bash
# Without API key (5 requests/minute limit)
python -m cve_sync.main

# With API key (50 requests/minute limit)
NVD_API_KEY=your_api_key python -m cve_sync.main

# Limit to first 5 pages for testing
NVD_MAX_PAGES=5 python -m cve_sync.main
```

### Docker Usage
```bash
# Build the image
docker build -t aegisflux/cve-sync .

# Run with Vault integration
docker run -e VAULT_ADDR=http://vault:8200 -e VAULT_TOKEN=your_token aegisflux/cve-sync

# Run with environment variables (fallback)
docker run -e NATS_URL=nats://nats:4222 -e NVD_API_KEY=your_key aegisflux/cve-sync
```

### Vault Usage
```bash
# Start Vault and bootstrap secrets
make vault-bootstrap

# Run CVE sync with Vault
VAULT_ADDR=http://localhost:8200 VAULT_TOKEN=root python -m cve_sync.main

# Test Vault integration
python test_vault_integration.py
```

## CVE Document Schema

The service publishes normalized CVE documents with the following structure:

```json
{
  "schema_version": "1.0",
  "cve_id": "CVE-2023-1234",
  "source": "nvd",
  "published": "2023-01-01T00:00:00.000",
  "last_modified": "2023-01-02T00:00:00.000",
  "descriptions": [
    {
      "lang": "en",
      "value": "CVE description...",
      "source": "nvd"
    }
  ],
  "cvss": {
    "base": {
      "v2": { "version": "2.0", "score": 7.5, "severity": "HIGH", ... },
      "v3": { "version": "3.0", "score": 8.1, "severity": "HIGH", ... },
      "v3.1": { "version": "3.1", "score": 8.1, "severity": "HIGH", ... }
    }
  },
  "cwe": [
    {
      "cwe_id": "CWE-79",
      "source": "nvd",
      "type": "Primary"
    }
  ],
  "affected_products": [
    {
      "cpe_name": "cpe:2.3:a:vendor:product:1.0.0:*:*:*:*:*:*:*",
      "vendor": "vendor",
      "product": "product",
      "version": "1.0.0",
      "vulnerable": true,
      "version_start_including": "1.0.0",
      "version_end_excluding": "1.1.0"
    }
  ],
  "references": [
    {
      "url": "https://example.com/advisory",
      "source": "vendor",
      "tags": ["Vendor Advisory"]
    }
  ],
  "ts": "2023-01-01T00:00:00.000Z"
}
```

## Monitoring

The service publishes to the `feeds.cve.updates` NATS subject. Monitor this subject to track CVE updates:

```bash
# Subscribe to CVE updates
nats sub "feeds.cve.updates" -s nats://localhost:4222
```

## Error Handling

- **Rate Limiting**: Automatic retry with exponential backoff
- **Network Timeouts**: 30-second timeout with retry logic
- **API Errors**: Proper error handling for 403, 429, and other HTTP status codes
- **Data Validation**: Skips invalid CVE entries and logs warnings
